<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>í˜œë‹¬ì´ì˜ ìƒíƒœ - ê³µìœ </title>
  <meta name="description" content="í˜œë‹¬ì´ê°€ ì§€ê¸ˆ ë­˜ í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”!">
  <meta property="og:title" content="í˜œë‹¬ì´ì˜ ìƒíƒœ">
  <meta property="og:description" content="í˜œë‹¬ì´ê°€ ì§€ê¸ˆ ë­˜ í•˜ê³  ìˆëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”!">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .shared-view {
      text-align: center;
      padding: 20px 0;
    }
    .shared-badge {
      display: inline-block;
      background: var(--accent);
      color: #fff;
      padding: 4px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .shared-mood {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 12px 0 4px;
    }
    .shared-message {
      font-size: 0.95rem;
      color: var(--text-light);
      margin-bottom: 16px;
    }
    .shared-timer-status {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 16px;
    }
    .shared-timer-status.focus {
      background: #FFF0E6;
      color: var(--accent-dark);
    }
    .shared-timer-status.break {
      background: #E8F8EC;
      color: #3A8F50;
    }
    .shared-todos {
      text-align: left;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 20px;
      margin-top: 16px;
    }
    .shared-todos h3 {
      font-size: 0.9rem;
      color: var(--text-light);
      margin-bottom: 10px;
    }
    .shared-todos li {
      font-size: 0.9rem;
      padding: 6px 0;
      border-bottom: 1px solid #F0E8DD;
      list-style: none;
    }
    .shared-todos li:last-child {
      border-bottom: none;
    }
    .shared-link-back {
      display: inline-block;
      margin-top: 20px;
      font-size: 0.85rem;
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
    }
    .shared-link-back:hover {
      text-decoration: underline;
    }
    .shared-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-light);
    }
  </style>
</head>
<body>
  <div id="app">
    <header class="header">
      <h1 class="header__title">í˜œë‹¬ì´ì˜ ìƒíƒœ</h1>
      <span class="shared-badge">ê³µìœ ëœ ìƒíƒœ</span>
    </header>

    <!-- í˜œë‹¬ì´ ìºë¦­í„° ì˜ì—­ -->
    <section class="otter-area">
      <div id="otter-container" class="otter-container"></div>
      <div id="otter-speech" class="otter-speech" hidden>
        <p id="otter-speech-text"></p>
      </div>
    </section>

    <!-- ê³µìœ  ì½˜í…ì¸  -->
    <div id="shared-content" class="shared-view">
      <!-- JSë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
    </div>

    <!-- ë°ì´í„°ê°€ ì—†ì„ ë•Œ -->
    <div id="shared-empty" class="shared-empty" hidden>
      <p>ê³µìœ ëœ ìƒíƒœê°€ ì—†ì–´ìš”!</p>
      <a href="index.html" class="shared-link-back">í˜œë‹¬ì´ ë§Œë‚˜ëŸ¬ ê°€ê¸° â†’</a>
    </div>
  </div>

  <script src="js/otter-svg.js"></script>
  <script>
    (function() {
      'use strict';

      const moodNames = {
        happy: 'í–‰ë³µí•´ ğŸ˜Š',
        focused: 'ì§‘ì¤‘! ğŸ”¥',
        tired: 'í”¼ê³¤í•´ ğŸ˜´',
        stressed: 'í˜ë“¤ì–´ ğŸ˜°',
        excited: 'ì‹ ë‚˜! ğŸ¥³',
        bored: 'ì‹¬ì‹¬í•´ ğŸ˜‘',
        loved: 'ì‚¬ë‘í•´ ğŸ¥°',
        hungry: 'ë°°ê³ íŒŒ ğŸ½ï¸',
        default: 'ê¸°ë³¸ ğŸ¦¦',
        eating: 'ëƒ ëƒ  ì¤‘ ğŸŸ',
        playing: 'ë†€ê³  ìˆì–´ âš½',
        sleeping: 'ìëŠ” ì¤‘ ğŸ’¤',
      };

      function decodeState() {
        const params = new URLSearchParams(window.location.search);
        if (!params.has('m') && !params.has('h')) return null;

        const data = {};
        if (params.has('m')) data.mood = params.get('m');
        if (params.has('h')) data.hunger = Number(params.get('h'));
        if (params.has('hp')) data.happiness = Number(params.get('hp'));
        if (params.has('e')) data.energy = Number(params.get('e'));
        if (params.has('lv')) data.level = Number(params.get('lv'));
        if (params.has('tr')) data.timerRunning = true;
        if (params.has('tb')) data.timerBreak = true;
        if (params.has('pc')) data.pomoCount = Number(params.get('pc'));
        if (params.has('msg')) data.message = params.get('msg');
        if (params.has('td')) {
          try { data.todos = JSON.parse(params.get('td')); } catch (e) { /* ë¬´ì‹œ */ }
        }
        return data;
      }

      function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function renderSharedView(data) {
        // í˜œë‹¬ì´ ë Œë”ë§
        OtterSVG.mount('otter-container', data.mood || 'default');

        const $content = document.getElementById('shared-content');
        if (!$content) return;

        let html = '';

        // ê¸°ë¶„
        const moodName = moodNames[data.mood] || moodNames.default;
        html += `<div class="shared-mood">${escapeHtml(moodName)}</div>`;

        // ë©”ì‹œì§€
        if (data.message) {
          html += `<div class="shared-message">"${escapeHtml(data.message)}"</div>`;
        }

        // íƒ€ì´ë¨¸ ìƒíƒœ
        if (data.timerRunning) {
          if (data.timerBreak) {
            html += `<div class="shared-timer-status break">â˜• íœ´ì‹ ì¤‘</div>`;
          } else {
            html += `<div class="shared-timer-status focus">ğŸ… ì§‘ì¤‘ ì¤‘</div>`;
          }
        }

        // ìƒíƒœë°”
        if (data.hunger != null) {
          html += `
            <div class="stats-bar" style="margin-top:16px">
              <div class="stat">
                <span class="stat__label">ë°°ê³ í””</span>
                <div class="stat__bar"><div class="stat__fill stat__fill--hunger" style="width:${data.hunger}%"></div></div>
              </div>
              <div class="stat">
                <span class="stat__label">í–‰ë³µë„</span>
                <div class="stat__bar"><div class="stat__fill stat__fill--happiness" style="width:${data.happiness || 50}%"></div></div>
              </div>
              <div class="stat">
                <span class="stat__label">ì—ë„ˆì§€</span>
                <div class="stat__bar"><div class="stat__fill stat__fill--energy" style="width:${data.energy || 50}%"></div></div>
              </div>
            </div>
          `;
        }

        // ë ˆë²¨
        if (data.level) {
          html += `<p style="font-size:0.9rem;color:var(--text-light);margin-top:8px">í˜œë‹¬ì´ Lv.${data.level}</p>`;
        }

        // ë½€ëª¨ë„ë¡œ íšŸìˆ˜
        if (data.pomoCount) {
          html += `<p style="font-size:0.85rem;color:var(--text-light)">ì˜¤ëŠ˜ ë½€ëª¨ë„ë¡œ ${data.pomoCount}íšŒ ì™„ë£Œ!</p>`;
        }

        // í•  ì¼ ëª©ë¡
        if (data.todos && data.todos.length > 0) {
          html += `<div class="shared-todos"><h3>í•  ì¼ ëª©ë¡</h3><ul>`;
          data.todos.forEach(text => {
            html += `<li>${escapeHtml(text)}</li>`;
          });
          html += `</ul></div>`;
        }

        html += `<a href="index.html" class="shared-link-back">ë‚˜ë„ í˜œë‹¬ì´ í‚¤ìš°ëŸ¬ ê°€ê¸° â†’</a>`;

        $content.innerHTML = html;
      }

      // ì´ˆê¸°í™”
      const data = decodeState();
      if (data) {
        renderSharedView(data);
      } else {
        document.getElementById('shared-content').hidden = true;
        document.getElementById('shared-empty').hidden = false;
        OtterSVG.mount('otter-container', 'default');
      }
    })();
  </script>
</body>
</html>
